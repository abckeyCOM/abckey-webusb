<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>abckey</title>
</head>

<body>
  <button onclick="add()">add</button>
  <br><br>
  <button onclick="ping()">Ping</button>
  <button onclick="initialize()">Initialize</button>
  <button onclick="getFeatures()">Get Features</button>
  <button onclick="clearSession()">Clear Session</button>
  <br><br>
  <button onclick="wipeDevice()">Wipe Device</button>
  <button onclick="resetDevice()">Reset Device</button>
  <button onclick="backupDevice()">Backup Device</button>
  <button onclick="recoverDevice()">Recover Device</button>
  <button onclick="checkSeed()">Check Seed</button>
  <button onclick="usePassphrase()">Use Passphrase</button>
  <br><br>
  <button onclick="getEntropy()">Get Entropy</button>
  <button onclick="applyFlags()">Apply Flags</button>
  <br><br>
  <button onclick="getPbk()">Get Public Key</button>
  <button onclick="getAddr()">Get Address</button>
  <br><br>
  <button onclick="signTx()">Sign Transaction</button>
  <button onclick="multisigTx()">Multisig Transaction</button>
  <br><br>
  <button onclick="pin(7)">*</button><button onclick="pin(8)">*</button><button onclick="pin(9)">*</button><br>
  <button onclick="pin(4)">*</button><button onclick="pin(5)">*</button><button onclick="pin(6)">*</button><br>
  <button onclick="pin(1)">*</button><button onclick="pin(2)">*</button><button onclick="pin(3)">*</button>
  <button onclick="pinAck()">Pin Ack</button>
  <button onclick="setPin()">Set Pin</button>
  <button onclick="offPin()">Off Pin</button>
  <br><br>
  <input id="pass" value="" />
  <button onclick="passAck()">Pass Ack</button>
  <br><br>
  <input id="word" value="" />
  <button onclick="wordAck()">Word Ack</button>
  <br><br>
  <input id="label" value="" />
  <button onclick="setLabel()">Set Label</button>
  <br><br>
  <input id="delay" value="60000" />
  <button onclick="lockDelay()">Auto Lock Delay (ms)</button>
  <script src="./js/_index.js"></script>
  <script>
    let abckey = require('abckey').default;
    abckey = new abckey({
      debug: true
    })

    abckey.onAdd(e => {
      console.log('onAdd', e)
    })

    abckey.onErr(e => {
      console.log('onErr', e)
    })

    abckey.onMsg(msg => {
      console.log('onMsg', msg)
    })

    async function add() {
      await abckey.add()
    }
    /******************************************************************************************/
    async function ping() {
      await abckey.cmd('Ping', {
        message: 'test',
        button_protection: true,
        pin_protection: true,
        passphrase_protection: true
      })
    }

    async function initialize() {
      await abckey.cmd('Initialize')
    }

    async function getFeatures() {
      await abckey.cmd('GetFeatures')
    }

    async function clearSession() {
      await abckey.cmd('ClearSession')
    }
    /******************************************************************************************/
    async function wipeDevice() {
      await abckey.cmd('WipeDevice')
    }

    async function resetDevice() {
      const result = await abckey.resetDevice({
        display_random: false,
        strength: 256, // 12word: 128, 18word: 192, 24word: 256,
        passphrase_protection: false,
        pin_protection: false,
        language: 'en-US',
        label: 'ABCKEY',
        skip_backup: true,
        no_backup: false,
        backup_type: 0, //Bip39: 0, Slip39_Basic: 1, Slip39_Advanced: 2
      })
      console.log('resetDevice', result)
    }

    async function backupDevice() {
      await abckey.cmd('BackupDevice')
    }

    async function recoverDevice() {
      await abckey.cmd('RecoveryDevice', {
        word_count: 24,
        passphrase_protection: false,
        pin_protection: false,
        language: 'en-US',
        label: 'ABCKEY',
        enforce_wordlist: false,
      })
    }

    async function checkSeed() {
      await abckey.cmd('RecoveryDevice', {
        dry_run: true
      })
    }

    async function wordAck() {
      const word = document.getElementById("word").value;
      await abckey.write('WordAck', { word })
    }
    /******************************************************************************************/
    async function getEntropy() {
      await abckey.cmd('GetEntropy', {
        size: 32
      })
    }

    async function applyFlags() {
      await abckey.cmd('ApplyFlags', {
        flags: '**'
      })
    }
    /******************************************************************************************/
    async function getPbk() {
      const result = await abckey.cmd('GetPublicKey', {
        coin_name: 'Bitcoin',
        address_n: [
          (49 | 0x80000000) >>> 0,
          (0 | 0x80000000) >>> 0,
          (0 | 0x80000000) >>> 0
        ],
        script_type: 4, // SPENDP2SHWITNESS: 4 ,PAYTOADDRESS: 0
        show_display: false
      })
      console.log('getPbk', result)
    }

    async function getAddr() {
      const result = await abckey.cmd('GetAddress', {
        coin_name: 'Bitcoin',
        address_n: [
          (49 | 0x80000000) >>> 0,
          (0 | 0x80000000) >>> 0,
          (0 | 0x80000000) >>> 0,
          0,
          0
        ],
        script_type: 4,
        show_display: true
      })
      console.log('getAddr', result)
    }

    async function signTx() {
      const result = await abckey.signTx({
        coin_name: 'Litecoin',
        inputs: [
          {
            "address_n": [
              2147483693,
              0,
              0,
              0
            ],
            "amount": "12519198",
            "prev_hash": "b83afccb701bf3cb5702c3ebfbf4acb217b2e578fc0f70576858fa2d96a432dc",
            "prev_index": 0,
            "script_type": "SPENDP2SHWITNESS",
            "sequence": 4294967293
          },
          {
            "address_n": [2147483697, 2147483650, 2147483648, 0, 1],
            "amount": "12519198",
            "prev_hash": "f6ceb5e14b4cb7bd8a2b1922bd2d91556de3be447c806141f225c3d77a0e99eb",
            "prev_index": 0,
            "script_type": "SPENDP2SHWITNESS",
            "sequence": 4294967295
          },
          {
            "address_n": [2147483697, 2147483650, 2147483648, 0, 2],
            "amount": "12519198",
            "prev_hash": "f6ceb5e14b4c47bd8a2b1922bd2d91556de3be447c806141f225c3d77a0e99eb",
            "prev_index": 0,
            "script_type": "SPENDP2SHWITNESS",
            "sequence": 4294967295
          }
        ],
        outputs: [
          {
            "address": "MX7rnVKyFrupJkAyLLWQy3QPt29vYcwsTN",
            "amount": "12519063",
            "script_type": "PAYTOADDRESS"
          },
          {
            "address": "MX7rnVKyFrupJkAyLLWQy3QPt29vYcwsTN",
            "amount": "1251",
            "script_type": "PAYTOADDRESS"
          },
          {
            "address": "MX7rnVKyFrupJkAyLLWQy3QPt29vYcwsTN",
            "amount": "1251",
            "script_type": "PAYTOADDRESS"
          }
        ]
      })
      console.log('signTx', result)
    }

    async function multisigTx() {
      inputs = [
        {
          "address_n": [2147483697, 2147483650, 2147483648, 0, 0],
          "amount": "12519198",
          "prev_hash": "f6ceb5e14b4cb7bd8a2b1922bd2d91596de3be447c806141f225c3d77a0e99eb",
          "prev_index": 0,
          "script_type": "SPENDP2SHWITNESS",
          "sequence": 4294967295
        },
        {
          "address_n": [2147483697, 2147483650, 2147483648, 0, 1],
          "amount": "12519198",
          "prev_hash": "f6ceb5e14b4cb7bd8a2b1922bd2d91556de3be447c806141f225c3d77a0e99eb",
          "prev_index": 0,
          "script_type": "SPENDP2SHWITNESS",
          "sequence": 4294967295
        },
        {
          "address_n": [2147483697, 2147483650, 2147483648, 0, 2],
          "amount": "12519198",
          "prev_hash": "f6ceb5e14b4c47bd8a2b1922bd2d91556de3be447c806141f225c3d77a0e99eb",
          "prev_index": 0,
          "script_type": "SPENDP2SHWITNESS",
          "sequence": 4294967295
        }
      ]
      outputs = [
        {
          "address": "MX7rnVKyFrupJkAyLLWQy3QPt29vYcwsTN",
          "amount": "12519063",
          "script_type": "PAYTOADDRESS"
        },
        {
          "address": "MX7rnVKyFrupJkAyLLWQy3QPt29vYcwsTN",
          "amount": "1251",
          "script_type": "PAYTOADDRESS"
        },
        {
          "address": "MX7rnVKyFrupJkAyLLWQy3QPt29vYcwsTN",
          "amount": "1251",
          "script_type": "PAYTOADDRESS"
        }
      ]
      const result = await abckey.signTx('Litecoin', inputs, outputs)
      console.log('signTransaction', result)
    }
    /******************************************************************************************/
    let __PIN__ = ''
    async function pin(n) { __PIN__ += n }
    async function setPin() { await abckey.cmd('ChangePin') }
    async function offPin() { await abckey.cmd('ChangePin', { remove: true }) }
    async function pinAck() {
      await abckey.write('PinMatrixAck', { pin: __PIN__ })
      __PIN__ = ''
    }
    /******************************************************************************************/
    async function setLabel() {
      const label = document.getElementById("label").value;
      await abckey.cmd('ApplySettings', { label })
    }
    async function lockDelay() {
      const auto_lock_delay_ms = document.getElementById("delay").value
      await abckey.cmd('ApplySettings', { auto_lock_delay_ms })
    }

    async function usePassphrase() {
      await abckey.cmd('ApplySettings', { use_passphrase: true })
    }

    async function passAck() {
      const passphrase = document.getElementById("pass").value
      await abckey.write('PassphraseAck', { passphrase })
    }

  </script>
</body>

</html>
