<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>abckey</title>
</head>

<body>
  <button onclick="add()">add</button>
  <br><br>
  <button onclick="ping()">Ping</button>
  <button onclick="initialize()">Initialize</button>
  <button onclick="getFeatures()">Get Features</button>
  <button onclick="clearSession()">Clear Session</button>
  <br><br>
  <button onclick="wipeDevice()">Wipe Device</button>
  <button onclick="resetDevice()">Reset Device</button>
  <button onclick="backupDevice()">Backup Device</button>
  <button onclick="recoverDevice()">Recover Device</button>
  <button onclick="checkSeed()">Check Seed</button>
  <button onclick="usePassphrase()">Use Passphrase</button>
  <br><br>
  <button onclick="getEntropy()">Get Entropy</button>
  <button onclick="applyFlags()">Apply Flags</button>
  <br><br>
  <button onclick="getPbk()">Get Public Key</button>
  <button onclick="getAddr()">Get Address</button>
  <button onclick="getAddrMultsig()">Get Address (multisig)</button>
  <br><br>
  <button onclick="signTx()">Sign Transaction</button>
  <button onclick="multisigTx()">Multisig Transaction</button>
  <br><br>
  <button onclick="pin(7)">*</button><button onclick="pin(8)">*</button><button onclick="pin(9)">*</button><br>
  <button onclick="pin(4)">*</button><button onclick="pin(5)">*</button><button onclick="pin(6)">*</button><br>
  <button onclick="pin(1)">*</button><button onclick="pin(2)">*</button><button onclick="pin(3)">*</button>
  <button onclick="pinAck()">Pin Ack</button>
  <button onclick="setPin()">Set Pin</button>
  <button onclick="offPin()">Off Pin</button>
  <br><br>
  <input id="pass" value="" />
  <button onclick="passAck()">Pass Ack</button>
  <br><br>
  <input id="word" value="" />
  <button onclick="wordAck()">Word Ack</button>
  <br><br>
  <input id="label" value="" />
  <button onclick="setLabel()">Set Label</button>
  <br><br>
  <input id="delay" value="60000" />
  <button onclick="lockDelay()">Auto Lock Delay (ms)</button>
  <script src="../dist/browserify_index.js"></script>
  <script>
    let abckey = require('abckey').default;
    abckey = new abckey({
      debug: true
    })

    abckey.onAdd(e => {
      console.log('onAdd', e)
    })

    abckey.onErr(e => {
      console.log('onErr', e)
    })

    abckey.onMsg(msg => {
      console.log('onMsg', msg)
    })

    async function add() {
      await abckey.add()
    }
    /******************************************************************************************/
    async function ping() {
      await abckey.cmd('Ping', {
        message: 'test',
        button_protection: true,
        pin_protection: true,
        passphrase_protection: true
      })
    }

    async function initialize() {
      await abckey.cmd('Initialize', null, true)
    }

    async function getFeatures() {
      await abckey.cmd('GetFeatures')
    }

    async function clearSession() {
      await abckey.cmd('ClearSession')
    }
    /******************************************************************************************/
    async function wipeDevice() {
      await abckey.cmd('WipeDevice')
    }

    async function resetDevice() {
      const result = await abckey.resetDevice({
        display_random: false,
        strength: 256, // 12word: 128, 18word: 192, 24word: 256,
        passphrase_protection: false,
        pin_protection: false,
        language: 'en-US',
        label: 'ABCKEY',
        skip_backup: true,
        no_backup: false,
        backup_type: 0, //Bip39: 0, Slip39_Basic: 1, Slip39_Advanced: 2
      })
      console.log('resetDevice', result)
    }

    async function backupDevice() {
      await abckey.cmd('BackupDevice')
    }

    async function recoverDevice() {
      await abckey.cmd('RecoveryDevice', {
        word_count: 24,
        passphrase_protection: false,
        pin_protection: false,
        language: 'en-US',
        label: 'ABCKEY',
        enforce_wordlist: false,
      })
    }

    async function checkSeed() {
      await abckey.cmd('RecoveryDevice', {
        dry_run: true
      })
    }

    async function wordAck() {
      const word = document.getElementById("word").value;
      await abckey.cmd('WordAck', { word })
    }
    /******************************************************************************************/
    async function getEntropy() {
      await abckey.cmd('GetEntropy', {
        size: 32
      })
    }

    async function applyFlags() {
      await abckey.cmd('ApplyFlags', {
        flags: '**'
      })
    }
    /******************************************************************************************/
    async function getPbk() {
      const result = await abckey.cmd('GetPublicKey', {
        coin_name: 'Bitcoin',
        address_n: [
          (49 | 0x80000000) >>> 0,
          (0 | 0x80000000) >>> 0,
          (0 | 0x80000000) >>> 0
        ],
        script_type: 4, // SPENDP2SHWITNESS: 4 ,PAYTOADDRESS: 0
        show_display: false
      })
      console.log('getPbk', result)
    }

    async function getAddr() {
      const result = await abckey.getAddr({
        address_n: [
          (49 | 0x80000000) >>> 0,
          (0 | 0x80000000) >>> 0,
          (0 | 0x80000000) >>> 0,
          0,
          0
        ],
        script_type: 'SPENDP2SHWITNESS',
        show_display: true
      })
      console.log('getAddr', result)
    }

    async function getAddrMultsig() {
      const result = await abckey.getAddr({
        address_n: [
          (45 | 0x80000000) >>> 0,
          0,
          0,
          0
        ],
        multisig: {
          pubkeys: [
            {
              node: 'xpub6DopkT3j23MNt4RYm3AwmxL1ydGTRU91eELyToPU2dbNh1aS6FeUnrhbX2vqNgacx4MtZTPrXnrfQjLJ9yTmX4BWRw6BqEGH6Cf8srLXNsB',
              address_n: [
                0,
                0
              ]
            },
            {
              node: 'xpub6F9ucJkut2FDrpvEGYBq59Bnfii1Jb52e9R6covwNvUkdCo18FGhRBvM8VaiCwBVzdKJGXwbY8HwJiw4uhnYi3oKnB3dxNZ3dELJASXrVLe',
              address_n: [
                0,
                0
              ]
            }
          ],
          m: 2,
        },
        script_type: 'SPENDMULTISIG',
        show_display: true
      })
      console.log('getAddrMultsig', result)
    }

    async function signTx() {
      const result = await abckey.signTx({
        coin_name: 'Litecoin',
        inputs: [
          {
            "address_n": [
              2147483693,
              0,
              0,
              0
            ],
            "amount": "12519198",
            "prev_hash": "b83afccb701bf3cb5702c3ebfbf4acb217b2e578fc0f70576858fa2d96a432dc",
            "prev_index": 0,
            "script_type": "SPENDP2SHWITNESS",
            "sequence": 4294967293
          },
          {
            "address_n": [2147483697, 2147483650, 2147483648, 0, 1],
            "amount": "12519198",
            "prev_hash": "f6ceb5e14b4cb7bd8a2b1922bd2d91556de3be447c806141f225c3d77a0e99eb",
            "prev_index": 0,
            "script_type": "SPENDP2SHWITNESS",
            "sequence": 4294967295
          },
          {
            "address_n": [2147483697, 2147483650, 2147483648, 0, 2],
            "amount": "12519198",
            "prev_hash": "f6ceb5e14b4c47bd8a2b1922bd2d91556de3be447c806141f225c3d77a0e99eb",
            "prev_index": 0,
            "script_type": "SPENDP2SHWITNESS",
            "sequence": 4294967295
          }
        ],
        outputs: [
          {
            "address": "MX7rnVKyFrupJkAyLLWQy3QPt29vYcwsTN",
            "amount": "12519063",
            "script_type": "PAYTOADDRESS"
          },
          {
            "address": "MX7rnVKyFrupJkAyLLWQy3QPt29vYcwsTN",
            "amount": "1251",
            "script_type": "PAYTOADDRESS"
          },
          {
            "address": "MX7rnVKyFrupJkAyLLWQy3QPt29vYcwsTN",
            "amount": "1251",
            "script_type": "PAYTOADDRESS"
          }
        ]
      })
      console.log('signTx', result)
    }

    async function multisigTx() {
      const inputs = [
        {
          address_n: [2147483693, 0, 0, 0],
          prev_hash: '37826a3b7ba54faaaee0c6195973dca7b7f6221ebd1756f8285e3be49b247d21',
          prev_index: 0,
          sequence: 4294967294,
          script_type: 'SPENDMULTISIG',
          amount: '1000100',
          multisig: {
            pubkeys: [
              {
                node: `xpub6BbAk2NX3geR1G5eJvww9qvgXPLZZZzE8oYpi56XQUSHH8u91kGYBcQXaHAMVNUnbeQQhS87nn38X8Y5YRj4UjA7gqtLEggpqQvZBp6W3NS`,
                address_n: [0, 0]
              },
              {
                node: 'xpub6AxX9fezLTUJwu2FrRkLcnLb6hdeiBXqabWasqnfvyacrgok92VJ3H963Qb28LH56TZD2T5HkHCB9HB74ADS6c4SEjQjenb2DG4xxFo7NWU',
                address_n: [0, 0]
              }
            ],
            signatures: ['', ''],
            m: 2
          }
        }
      ]
      const outputs = [
        {
          address: '3L6UYMqVLxzZRJ9EpZpf3o5ZvWWs1KNjQb',
          amount: '9',
          script_type: 'PAYTOADDRESS'
        }
      ]
      const utxo = [
        {
          hash: '37826a3b7ba54faaaee0c6195973dca7b7f6221ebd1756f8285e3be49b247d21',
          inputs: [
            {
              prev_hash: 'a653e5b4e9b1ac110540f97b97ab97cc7ad9a1e81e844b223500d68697192cd4',
              prev_index: 0,
              script_sig: '160014fee4152a9ec43bedacc7238b28c848c5272eb0fc',
              sequence: 4294967294
            }
          ],
          bin_outputs: [
            {
              amount: '1000100',
              script_pubkey: 'a914b5619f06ad24e8a44fd8e0b14f6c095cede7aa4b87'
            },
            {
              amount: '15687407',
              script_pubkey: 'a91495183a50937681facfb6cf071548795e07c7127d87'
            }
          ],
          lock_time: 621597,
          version: 2
        }
      ]
      const result = await abckey.signTx({
        coin_name: 'Bitcoin',
        inputs,
        outputs,
        utxo,
        version: 2,
        lock_time: 621597
      })
      console.log('signTx', result)
    }
    /******************************************************************************************/
    let __PIN__ = ''
    async function pin(n) { __PIN__ += n }
    async function setPin() { await abckey.cmd('ChangePin') }
    async function offPin() { await abckey.cmd('ChangePin', { remove: true }) }
    async function pinAck() {
      await abckey.cmd('PinMatrixAck', { pin: __PIN__ })
      __PIN__ = ''
    }
    /******************************************************************************************/
    async function setLabel() {
      const label = document.getElementById("label").value;
      await abckey.cmd('ApplySettings', { label })
    }

    async function lockDelay() {
      const auto_lock_delay_ms = document.getElementById("delay").value
      await abckey.cmd('ApplySettings', { auto_lock_delay_ms })
    }

    async function usePassphrase() {
      await abckey.cmd('ApplySettings', { use_passphrase: true })
    }

    async function passAck() {
      const passphrase = document.getElementById("pass").value
      await abckey.cmd('PassphraseAck', { passphrase })
    }

  </script>
</body>

</html>
