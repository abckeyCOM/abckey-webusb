<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>abckey</title>
</head>

<body>
  <button onclick="add()">add</button>
  <br><br>
  <button onclick="ping()">Ping</button>
  <button onclick="initialize()">Initialize</button>
  <button onclick="getFeatures()">Get Features</button>
  <button onclick="clearSession()">Clear Session</button>
  <br><br>
  <button onclick="wipeDevice()">Wipe Device</button>
  <button onclick="resetDevice()">Reset Device</button>
  <button onclick="backupDevice()">Backup Device</button>
  <button onclick="recoverDevice()">Recover Device</button>
  <button onclick="checkSeed()">Check Seed</button>
  <button onclick="usePassphrase()">Use Passphrase</button>
  <br><br>
  <button onclick="getEntropy()">Get Entropy</button>
  <button onclick="applyFlags()">Apply Flags</button>
  <br><br>
  <button onclick="getPbk()">Get Public Key</button>
  <button onclick="getAddr()">Get Address</button>
  <button onclick="getAddrMultsig()">Get Address (multisig)</button>
  <br><br>
  <button onclick="signTx()">Sign Transaction</button>
  <button onclick="multisigTx()">Multisig Transaction</button>
  <br><br>
  <button onclick="pin(7)">*</button><button onclick="pin(8)">*</button><button onclick="pin(9)">*</button><br>
  <button onclick="pin(4)">*</button><button onclick="pin(5)">*</button><button onclick="pin(6)">*</button><br>
  <button onclick="pin(1)">*</button><button onclick="pin(2)">*</button><button onclick="pin(3)">*</button>
  <button onclick="pinAck()">Pin Ack</button>
  <button onclick="setPin()">Set Pin</button>
  <button onclick="offPin()">Off Pin</button>
  <br><br>
  <input id="pass" value="" />
  <button onclick="passAck()">Pass Ack</button>
  <br><br>
  <input id="word" value="" />
  <button onclick="wordAck()">Word Ack</button>
  <br><br>
  <input id="label" value="" />
  <button onclick="setLabel()">Set Label</button>
  <br><br>
  <input id="delay" value="60000" />
  <button onclick="lockDelay()">Auto Lock Delay (ms)</button>
  <script src="../dist/browserify_index.js"></script>
  <script>
    let abckey = require('abckey').default;
    abckey = new abckey({
      debug: true
    })

    abckey.onAdd(e => {
      console.log('onAdd', e)
    })

    abckey.onErr(e => {
      console.log('onErr', e)
    })

    abckey.onMsg(msg => {
      console.log('onMsg', msg)
    })

    async function add() {
      await abckey.add()
    }
    /******************************************************************************************/
    async function ping() {
      await abckey.cmd('Ping', {
        message: 'test',
        button_protection: true,
        pin_protection: true,
        passphrase_protection: true
      })
    }

    async function initialize() {
      const msg = await abckey.cmd('Initialize')
      console.log(msg)
    }

    async function getFeatures() {
      await abckey.cmd('GetFeatures')
    }

    async function clearSession() {
      await abckey.cmd('ClearSession')
    }
    /******************************************************************************************/
    async function wipeDevice() {
      await abckey.cmd('WipeDevice')
    }

    async function resetDevice() {
      const result = await abckey.resetDevice({
        display_random: false,
        strength: 256, // 12word: 128, 18word: 192, 24word: 256,
        passphrase_protection: false,
        pin_protection: false,
        language: 'en-US',
        label: 'ABCKEY',
        skip_backup: true,
        no_backup: false,
        backup_type: 0, //Bip39: 0, Slip39_Basic: 1, Slip39_Advanced: 2
      })
      console.log('resetDevice', result)
    }

    async function backupDevice() {
      await abckey.cmd('BackupDevice')
    }

    async function recoverDevice() {
      await abckey.cmd('RecoveryDevice', {
        word_count: 24,
        passphrase_protection: false,
        pin_protection: false,
        language: 'en-US',
        label: 'ABCKEY',
        enforce_wordlist: false,
      })
    }

    async function checkSeed() {
      await abckey.cmd('RecoveryDevice', {
        dry_run: true
      })
    }

    async function wordAck() {
      const word = document.getElementById("word").value;
      await abckey.cmd('WordAck', { word })
    }
    /******************************************************************************************/
    async function getEntropy() {
      await abckey.cmd('GetEntropy', {
        size: 32
      })
    }

    async function applyFlags() {
      await abckey.cmd('ApplyFlags', {
        flags: '**'
      })
    }
    /******************************************************************************************/
    async function getPbk() {
      const result = await abckey.cmd('GetPublicKey', {
        coin_name: 'Bitcoin',
        address_n: [
          (49 | 0x80000000) >>> 0,
          (0 | 0x80000000) >>> 0,
          (0 | 0x80000000) >>> 0
        ],
        script_type: 4, // SPENDP2SHWITNESS: 4 ,PAYTOADDRESS: 0
        show_display: false
      })
      console.log('getPbk', result)
    }

    async function getAddr() {
      const result = await abckey.getAddr({
        address_n: [
          (49 | 0x80000000) >>> 0,
          (0 | 0x80000000) >>> 0,
          (0 | 0x80000000) >>> 0,
          0,
          0
        ],
        script_type: 'SPENDP2SHWITNESS',
        show_display: true
      })
      console.log('getAddr', result)
    }

    async function getAddrMultsig() {
      const result = await abckey.getAddr({
        address_n: [
          (45 | 0x80000000) >>> 0,
          0,
          0,
          0
        ],
        multisig: {
          pubkeys: [
            {
              node: 'xpub6DopkT3j23MNt4RYm3AwmxL1ydGTRU91eELyToPU2dbNh1aS6FeUnrhbX2vqNgacx4MtZTPrXnrfQjLJ9yTmX4BWRw6BqEGH6Cf8srLXNsB',
              address_n: [
                0,
                0
              ]
            },
            {
              node: 'xpub6F9ucJkut2FDrpvEGYBq59Bnfii1Jb52e9R6covwNvUkdCo18FGhRBvM8VaiCwBVzdKJGXwbY8HwJiw4uhnYi3oKnB3dxNZ3dELJASXrVLe',
              address_n: [
                0,
                0
              ]
            }
          ],
          m: 2,
        },
        script_type: 'SPENDMULTISIG',
        show_display: true
      })
      console.log('getAddrMultsig', result)
    }

    async function signTx() {
      const result = await abckey.signTx({
        coin_name: 'Litecoin',
        inputs: [
          {
            "address_n": [
              2147483693,
              0,
              0,
              0
            ],
            "amount": "12519198",
            "prev_hash": "b83afccb701bf3cb5702c3ebfbf4acb217b2e578fc0f70576858fa2d96a432dc",
            "prev_index": 0,
            "script_type": "SPENDP2SHWITNESS",
            "sequence": 4294967293
          },
          {
            "address_n": [2147483697, 2147483650, 2147483648, 0, 1],
            "amount": "12519198",
            "prev_hash": "f6ceb5e14b4cb7bd8a2b1922bd2d91556de3be447c806141f225c3d77a0e99eb",
            "prev_index": 0,
            "script_type": "SPENDP2SHWITNESS",
            "sequence": 4294967295
          },
          {
            "address_n": [2147483697, 2147483650, 2147483648, 0, 2],
            "amount": "12519198",
            "prev_hash": "f6ceb5e14b4c47bd8a2b1922bd2d91556de3be447c806141f225c3d77a0e99eb",
            "prev_index": 0,
            "script_type": "SPENDP2SHWITNESS",
            "sequence": 4294967295
          }
        ],
        outputs: [
          {
            "address": "MX7rnVKyFrupJkAyLLWQy3QPt29vYcwsTN",
            "amount": "12519063",
            "script_type": "PAYTOADDRESS"
          },
          {
            "address": "MX7rnVKyFrupJkAyLLWQy3QPt29vYcwsTN",
            "amount": "1251",
            "script_type": "PAYTOADDRESS"
          },
          {
            "address": "MX7rnVKyFrupJkAyLLWQy3QPt29vYcwsTN",
            "amount": "1251",
            "script_type": "PAYTOADDRESS"
          },
          {
            "address_n": [
              2147483693,
              0,
              0,
              0
            ],
            "amount": "1251",
            "script_type": "PAYTOADDRESS"
          },
        ]
      })
    }

    async function multisigTx() {
      const inputs = [
        {
          "address_n": [
            2147483692,
            2147483648,
            2147483648
          ],
          "prev_hash": "b3e400a6ec426652f22e7cc9056388713b27040ecd6620820b4e88e422b9dbb4",
          "prev_index": 0,
          "sequence": 4294967295,
          "script_type": "SPENDMULTISIG",
          "amount": "305170",
          "multisig": {
            "pubkeys": [
              {
                "node": "xpub6CQrHpo3WyZUick9cZX62LnizmfkYXAWki6gaNsg7qcWwxGfPdcevpJLdndWh1DKpxbhZuB7PQWzYaA2myuMD2Y5ADm4AFeDczxryEEt2dA",
                "address_n": []
              },
              {
                "node": "xpub6EM1j8mUpjLTH3yu3m95EnadifxH9cJho9HeyK9sySpiSdEkniaJbpvwkJLQJaVZ91p1CTX2PtSD1xubAnbqUDbLL6eiAaVof38GRnfttmr",
                "address_n": []
              },
              {
                "node": "xpub6Cv91ksLxY6mP88jy3xLGhe4AgxRsSmJDD3xJbxhkEJEZRXtn4gAcQf7CAURhvWZWqYqLMT5eqSDF5TwB6oX7HEwSEYDfNHx4FD55A1Rwwi",
                "address_n": []
              },
              {
                "node": "xpub6CB1p2e5RYzJbv4UnKacXQLQyFKRz2iaXp7N1TZzcBB5kXZqrZdwpZcGkaWPN1wpmtaxQztVt27ExmmaoT7imJrmNaF1NLQUAGnCmigrBxM",
                "address_n": []
              },
              {
                "node": "xpub6Ei4K7R6Cuu4Nf1QNm2rf3C8LCHiYqrkVTAAaXWgehzK1fuKpRCwjmUv5w7KLaitC9nfXke34wna3jjZtup9HTimhiiTZoKRWhYHdfeAcUx",
                "address_n": []
              }
            ],
            "signatures": [
              "",
              "",
              "",
              ""
            ],
            "m": 4
          }
        }
      ]
      const outputs = [
        {
          "address": "321m4ZKqkPfE27kXZEvfXxrroMiXeL1K9p",
          "amount": "1000",
          "script_type": "PAYTOADDRESS"
        },
        {
          "address": "1Dxzq1eqMmskCWYuUgkJDvTbBHr5sqG2ZY",
          "amount": "1000",
          "script_type": "PAYTOADDRESS"
        }
      ]

      const utxo = [
        {
          "version": 2,
          "hash": "b3e400a6ec426652f22e7cc9056388713b27040ecd6620820b4e88e422b9dbb4",
          "inputs": [
            {
              "prev_index": 1,
              "sequence": 4294967295,
              "prev_hash": "b02f47429905f7b0e2d49f6753b8314a205205c2978cc8236793b6886080c89a",
              "script_sig": "1600145718c9aee8fb71b8d2df1d878968dd5310977a98"
            }
          ],
          "bin_outputs": [
            {
              "amount": "12619",
              "script_pubkey": "a914038b7f4bd1e2305a2b72dfab094fa392fedd7f3187"
            },
            {
              "amount": "292551",
              "script_pubkey": "a9141191ece76da3009434dd6bd2bf8a36296e032a1987"
            }
          ],
          "lock_time": 0
        }
      ]
      const result = await abckey.signTx({
        coin_name: 'Bitcoin',
        inputs,
        outputs,
        utxo,
        version: 2,
        lock_time: 0
      })
      console.log('signTx', result)
    }
    /******************************************************************************************/
    let __PIN__ = ''
    async function pin(n) { __PIN__ += n }
    async function setPin() { await abckey.cmd('ChangePin') }
    async function offPin() { await abckey.cmd('ChangePin', { remove: true }) }
    async function pinAck() {
      await abckey.cmd('PinMatrixAck', { pin: __PIN__ })
      __PIN__ = ''
    }
    /******************************************************************************************/
    async function setLabel() {
      const label = document.getElementById("label").value;
      await abckey.cmd('ApplySettings', { label })
    }

    async function lockDelay() {
      const auto_lock_delay_ms = document.getElementById("delay").value
      await abckey.cmd('ApplySettings', { auto_lock_delay_ms })
    }

    async function usePassphrase() {
      await abckey.cmd('ApplySettings', { use_passphrase: true })
    }

    async function passAck() {
      const passphrase = document.getElementById("pass").value
      await abckey.cmd('PassphraseAck', { passphrase })
    }

  </script>
</body>

</html>
